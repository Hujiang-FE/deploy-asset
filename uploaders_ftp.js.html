<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: uploaders/ftp.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: uploaders/ftp.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * deploy-asset
 * https://github.com/qiu8310/deploy-asset
 *
 * Copyright (c) 2015 Zhonglei Qiu
 * Licensed under the MIT license.
 */

var FTP = require('jsftp-mkdirp')(require('jsftp'));
var path = require('path');
var log = require('npmlog');
var async = require('async');
var _ = require('lodash');


var Uploader = require('../uploader');


/**
 *
 * 这里你可以检查用户配置，如果配置有误可以抛出异常
 *
 * @constructor FtpUploader
 * @extends Uploader
 * @param {Object} opts
 * @param {String} opts.host      - FTP 域名
 * @param {String} opts.user      - FTP 用户名
 * @param {String} opts.pass      - FTP 密码
 * @param {Number} opts.port      - FTP 端口，可选配置，默认是 22
 * @param {String} opts.destDir   - 要上传到 FTP 上的的目录
 * @param {String} opts.baseUrl   - 站点基准 url
 *
 *
 */
function FtpUploader(opts) {

  var self = this;
  ['host', 'user', 'pass', 'destDir', 'baseUrl'].forEach(function(key) {
    if (!opts[key] &amp;&amp; !_.isString(opts[key])) {
      throw new Error('Please set your ftp\'s ' + key + ' option to a valid String value');
    }
    self[key] = opts[key];
  });

  self.port = opts.port || 21;
  var appendDestDirToBaseUrl = ('appendDestDirToBaseUrl' in opts) ? opts.appendDestDirToBaseUrl : true;

  log.info('Create ftp');
  self.ftp = new FTP({host: self.host, user: self.user, pass: self.pass, port: self.port});

  self.baseUrl = self.normalizeBaseUrl(opts.baseUrl);
  if (appendDestDirToBaseUrl) self.baseUrl += self.destDir.replace(/^\/|\/$/g, '') + '/';
  self.enableBatchUpload = true;
  self.supportFlatAssets = true;
}


FtpUploader.prototype.endFtp = function () {
  this.ftp.raw.quit(function (err) {
    if (err) {
      log.warn('FTP connection ended with error', err);
    }
  });
};

FtpUploader.prototype.cwdFtp = function (dir, cb) {
  var self = this;
  this.ftp.mkdirp(dir, function (err) {
    if (err) return cb(err);
    self.ftp.raw.cwd(dir, cb);
  });
};


/**
 *
 * @method
 * @override
 *
 * @borrows Uploader.setFileRemotePath
 */
FtpUploader.prototype.setFileRemotePath = function(file) {
  file.remote.path = this.baseUrl + path.join(file.remote.relative, file.remote.basename);
};

/**
 *
 * @method
 * @override
 * @borrows Uploader.uploadFile
 */
FtpUploader.prototype.batchUploadFiles = function(files, cb) {
  var self = this;

  var end = function (err) {
    self.endFtp();
    cb(err);
  };

  var iterate = function (file, done) {
    var relative = file.remote.relative;
    var remotePath = path.join(relative, file.remote.basename);
    var put = function () {
      self.ftp.put(file.content, remotePath, done);
    };

    if (!relative) return put();

    self.ftp.mkdirp(path.join(self.destDir, relative), function (err) {
      if (err) return done(err);
      put();
    });
  };

  this.cwdFtp(this.destDir, function (err) {
    if (err) return end(err);
    async.eachSeries(files, iterate, end);
  });
};


/* 为了生成好看点的 jsdoc 文档才这样写的 */
module.exports = Uploader.extend({
  constructor: FtpUploader,
  cwdFtp: FtpUploader.prototype.cwdFtp,
  endFtp: FtpUploader.prototype.endFtp,
  setFileRemotePath: FtpUploader.prototype.setFileRemotePath,
  batchUploadFiles: FtpUploader.prototype.batchUploadFiles
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="File.html">File</a></li><li><a href="FtpUploader.html">FtpUploader</a></li><li><a href="QiniuUploader.html">QiniuUploader</a></li><li><a href="Uploader.html">Uploader</a></li><li><a href="UpyunUploader.html">UpyunUploader</a></li></ul><h3>Global</h3><ul><li><a href="global.html#da">da</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta3</a> on Sat Sep 19 2015 14:37:19 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
